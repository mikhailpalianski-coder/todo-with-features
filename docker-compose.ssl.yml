services:
  mongodb: 
    image: mongo:latest
    container_name: mongodb
    ports:
      - "27017:27017"
    environment:
      - MONGO_INITDB_ROOT_USERNAME=admin
      - MONGO_INITDB_ROOT_PASSWORD=password
    volumes:
      - mongodb_data:/data/db
    networks:
      - app-network

  # Server instance 1 (primary - handles most traffic)
  server1:
    build:
      context: ./server
      dockerfile: Dockerfile.dev
    container_name: server1
    environment:
      - NODE_ENV=development
      - MONGODB_URI=mongodb://admin:password@mongodb:27017/todo?authSource=admin
      - SERVER_ID=server1
      - HOSTNAME=server1
    volumes:
      - ./server/src:/app/src
      - ./server/test:/app/test
      - ./server/tsconfig.json:/app/tsconfig.json
      - ./server/tsconfig.build.json:/app/tsconfig.build.json
      - ./server/nest-cli.json:/app/nest-cli.json
    depends_on:
      - mongodb
    networks:
      - app-network
    restart: unless-stopped

  # Server instance 2 (secondary - handles moderate traffic)
  server2:
    build:
      context: ./server
      dockerfile: Dockerfile.dev
    container_name: server2
    environment:
      - NODE_ENV=development
      - MONGODB_URI=mongodb://admin:password@mongodb:27017/todo?authSource=admin
      - SERVER_ID=server2
      - HOSTNAME=server2
    volumes:
      - ./server/src:/app/src
      - ./server/test:/app/test
      - ./server/tsconfig.json:/app/tsconfig.json
      - ./server/tsconfig.build.json:/app/tsconfig.build.json
      - ./server/nest-cli.json:/app/nest-cli.json
    depends_on:
      - mongodb
    networks:
      - app-network
    restart: unless-stopped

  # Server instance 3 (backup - only used if others fail)
  server3:
    build:
      context: ./server
      dockerfile: Dockerfile.dev
    container_name: server3
    environment:
      - NODE_ENV=development
      - MONGODB_URI=mongodb://admin:password@mongodb:27017/todo?authSource=admin
      - SERVER_ID=server3
      - HOSTNAME=server3
    volumes:
      - ./server/src:/app/src
      - ./server/test:/app/test
      - ./server/tsconfig.json:/app/tsconfig.json
      - ./server/tsconfig.build.json:/app/tsconfig.build.json
      - ./server/nest-cli.json:/app/nest-cli.json
    depends_on:
      - mongodb
    networks:
      - app-network
    restart: unless-stopped

  client:
    build:
      context: ./client
      dockerfile: Dockerfile
    container_name: client
    depends_on:
      - server1
    networks:
      - app-network
    restart: unless-stopped

  # Certbot for Let's Encrypt certificates
  certbot:
    image: certbot/certbot
    container_name: certbot
    volumes:
      - certbot-data:/etc/letsencrypt
      - certbot-www:/var/www/certbot
    command: certonly --webroot --webroot-path=/var/www/certbot --email your-email@example.com --agree-tos --no-eff-email -d your-domain.com -d www.your-domain.com
    networks:
      - app-network

  nginx:
    image: nginx:alpine
    container_name: nginx
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx/nginx-ssl.conf:/etc/nginx/conf.d/default.conf:ro
      - ./ssl:/etc/nginx/ssl:ro
      - certbot-data:/etc/letsencrypt:ro
      - certbot-www:/var/www/certbot:ro
    depends_on:
      - server1
      - server2
      - server3
      - client
    networks:
      - app-network
    restart: unless-stopped

volumes:
  mongodb_data:
  certbot-data:
  certbot-www:

networks:
  app-network:
    driver: bridge

